<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Level Game</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            background-color: #222;
            color: white;
            -webkit-user-select: none;
            user-select: none;
        }
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            box-sizing: border-box;
            padding: 20px;
        }
        .hidden {
            display: none !important;
        }
        button {
            padding: 12px 20px;
            font-size: 18px;
            cursor: pointer;
            background: #555;
            color: white;
            border: 2px solid white;
            margin: 10px;
            border-radius: 0;
            transition: background-color 0.2s ease;
        }
        button:hover {
            background: #777;
        }
        button:active {
            background: #444;
        }
        canvas {
            border: 2px solid white;
            background: #333;
            flex-shrink: 0;
        }
        #game-screen canvas {
            cursor: default;
        }
        #game-over-overlay {
            /* This overlay is now only for the initial click, not the persistent image */
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #game-over-overlay img {
            max-width: 100%;
            max-height: 100%;
        }
        #cookie-consent-text {
            max-width: 600px;
            text-align: center;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        #cookie-consent-text a {
            color: #00aaff;
        }
        
        /* --- MOBILE CONTROLS --- */
        #mobile-game-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            gap: 15px;
        }
        .mobile-control-btn {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid white;
            color: white;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            border-radius: 0;
        }
        .mobile-control-btn:active {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>

    <div id="cookie-consent-screen" class="screen">
        <h1>We Use Cookies</h1>
        <div id="cookie-consent-text">
            <p>This website uses cookies to enhance your experience. By clicking "Agree", you agree to our use of cookies.</p>
        </div>
        <button id="acceptBtn">Agree</button>
    </div>

    <div id="menu-screen" class="screen hidden">
        <h1>Level Game</h1>
        <button id="playBtn">Play</button>
    </div>

    <div id="game-screen" class="screen hidden">
        <canvas id="gameCanvas" width="800" height="400"></canvas>
        <p>Controls: A/D or Arrow Keys to move, W/Space to jump</p>
    </div>

    <!-- This is the temporary overlay that appears on death -->
    <div id="game-over-overlay" class="screen hidden">
        <img src="assets/game-over.gif" alt="Game Over">
    </div>

    <!-- This is the PERMANENT overlay that appears after death -->
    <div id="permanent-game-over" class="screen hidden">
    </div>

    <!-- MOBILE CONTROLS -->
    <div id="mobile-game-controls" class="hidden">
        <div id="mobile-left" class="mobile-control-btn">◄</div>
        <div id="mobile-jump" class="mobile-control-btn">▲</div>
        <div id="mobile-right" class="mobile-control-btn">►</div>
    </div>

    <script>
        const isMobileDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        const CONSENT_KEY = 'cookieConsentGiven';

        const consentScreen = document.getElementById('cookie-consent-screen');
        const menuScreen = document.getElementById('menu-screen');
        const gameScreen = document.getElementById('game-screen');
        const gameOverOverlay = document.getElementById('game-over-overlay');
        const permanentGameOverOverlay = document.getElementById('permanent-game-over');
        const mobileControls = document.getElementById('mobile-game-controls');
        const acceptBtn = document.getElementById('acceptBtn');
        const playBtn = document.getElementById('playBtn');

        let animationId;
        let currentLevel = {};
        let isGameOver = false;
        let currentLevelIndex = 0;

        // Define the three levels with fixed layouts and player start positions
        const levels = [
            {
                name: "Level 1: The Beginning",
                playerStart: { x: 150, y: 300 }, // Start player on the first platform
                cubes: [{ x: 100, y: 350, width: 100, height: 50 }, { x: 300, y: 350, width: 100, height: 50 }, { x: 500, y: 350, width: 100, height: 50 }],
                deathCubes: [],
                movingCubes: [],
                winPortal: { x: 720, y: 300, width: 40, height: 50 } // Portal on platform
            },
            {
                name: "Level 2: A Little Harder",
                playerStart: { x: 150, y: 300 },
                cubes: [{ x: 100, y: 350, width: 100, height: 50 }, { x: 200, y: 280, width: 80, height: 20 }, { x: 400, y: 220, width: 80, height: 20 }, { x: 600, y: 350, width: 100, height: 50 }],
                deathCubes: [{ x: 280, y: 330, width: 40, height: 40 }, { x: 480, y: 330, width: 40, height: 40 }],
                movingCubes: [{ x: 350, y: 150, width: 60, height: 20, speed: 2, range: 100, direction: 1, initialX: 350 }],
                winPortal: { x: 720, y: 300, width: 40, height: 50 } // Portal on platform
            },
            {
                name: "Level 3: The Final Challenge",
                playerStart: { x: 150, y: 300 },
                cubes: [{ x: 100, y: 350, width: 100, height: 50 }, { x: 200, y: 320, width: 60, height: 20 }, { x: 350, y: 250, width: 60, height: 20 }, { x: 500, y: 180, width: 60, height: 20 }, { x: 650, y: 110, width: 100, height: 20 }],
                deathCubes: [{ x: 130, y: 330, width: 40, height: 40 }, { x: 260, y: 300, width: 40, height: 40 }, { x: 410, y: 230, width: 40, height: 40 }, { x: 560, y: 160, width: 40, height: 40 }],
                movingCubes: [{ x: 150, y: 200, width: 50, height: 20, speed: 3, range: 120, direction: 1, initialX: 150 }, { x: 450, y: 100, width: 50, height: 20, speed: 2, range: 80, direction: -1, initialX: 450 }],
                winPortal: { x: 720, y: 60, width: 40, height: 50 } // Portal on platform
            }
        ];

        function showScreen(screenToShow) {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.add('hidden'));
            screenToShow.classList.remove('hidden');

            if (isMobileDevice && screenToShow === gameScreen) {
                mobileControls.classList.remove('hidden');
            } else {
                mobileControls.classList.add('hidden');
            }
        }

        // Initial screen logic
        if (localStorage.getItem(CONSENT_KEY) !== 'true') {
            showScreen(consentScreen);
        } else {
            showScreen(menuScreen);
        }

        acceptBtn.addEventListener('click', () => {
            localStorage.setItem(CONSENT_KEY, 'true');
            showScreen(menuScreen);
        });

        playBtn.addEventListener('click', () => {
            currentLevelIndex = 0;
            startLevel(currentLevelIndex);
        });

        gameOverOverlay.addEventListener('click', () => {
            // This click now does nothing, the permanent overlay is already shown
        });

        function startLevel(levelIndex) {
            isGameOver = false;
            showScreen(gameScreen);
            currentLevel = JSON.parse(JSON.stringify(levels[levelIndex]));
            const gameCanvas = document.getElementById('gameCanvas'); 
            const ctx = gameCanvas.getContext('2d');
            
            // Use the player start position from the level data
            const player = { 
                x: currentLevel.playerStart.x, 
                y: currentLevel.playerStart.y, 
                width: 30, 
                height: 30, 
                velocityX: 0, 
                velocityY: 0, 
                speed: 5, 
                jumpPower: -12, 
                isJumping: false 
            };
            
            const keys = {};
            const touchControls = { leftPressed: false, rightPressed: false };

            const keyDownHandler = (e) => { keys[e.code] = true; };
            const keyUpHandler = (e) => { keys[e.code] = false; };
            window.addEventListener('keydown', keyDownHandler);
            window.addEventListener('keyup', keyUpHandler);

            const mobileLeft = document.getElementById('mobile-left');
            const mobileRight = document.getElementById('mobile-right');
            const mobileJump = document.getElementById('mobile-jump');

            mobileLeft.addEventListener('touchstart', (e) => { e.preventDefault(); touchControls.leftPressed = true; });
            mobileLeft.addEventListener('touchend', (e) => { e.preventDefault(); touchControls.leftPressed = false; });
            mobileRight.addEventListener('touchstart', (e) => { e.preventDefault(); touchControls.rightPressed = true; });
            mobileRight.addEventListener('touchend', (e) => { e.preventDefault(); touchControls.rightPressed = false; });
            mobileJump.addEventListener('touchstart', (e) => { e.preventDefault(); if (!player.isJumping) { player.velocityY = player.jumpPower; player.isJumping = true; } });

            function gameLoop() {
                if (isGameOver) return;
                ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
                
                ctx.fillStyle = '#1a1a2e';
                ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);
                
                player.velocityX = 0;
                if (keys['KeyA'] || keys['ArrowLeft'] || touchControls.leftPressed) player.velocityX = -player.speed;
                if (keys['KeyD'] || keys['ArrowRight'] || touchControls.rightPressed) player.velocityX = player.speed;
                if ((keys['KeyW'] || keys['Space'] || keys['ArrowUp']) && !player.isJumping) { 
                    player.velocityY = player.jumpPower; 
                    player.isJumping = true; 
                }
                
                player.velocityY += 0.5; 
                player.x += player.velocityX; 
                player.y += player.velocityY;
                
                if (player.x < 0) player.x = 0; 
                if (player.x + player.width > gameCanvas.width) player.x = gameCanvas.width - player.width;
                
                player.isJumping = true;
                currentLevel.cubes.forEach(cube => {
                    if (player.x < cube.x + cube.width && player.x + player.width > cube.x && player.y < cube.y + cube.height && player.y + player.height > cube.y) {
                        if (player.velocityY > 0 && player.y < cube.y) { player.y = cube.y - player.height; player.velocityY = 0; player.isJumping = false; }
                        else if (player.velocityY < 0 && player.y > cube.y) { player.y = cube.y + cube.height; player.velocityY = 0; }
                        else if (player.velocityX > 0 && player.x < cube.x) { player.x = cube.x - player.width; }
                        else if (player.velocityX < 0 && player.x > cube.x) { player.x = cube.x + cube.width; }
                    }
                });

                currentLevel.movingCubes.forEach(cube => {
                    if (!cube.direction) cube.direction = 1;
                    if (!cube.speed) cube.speed = 2;
                    if (!cube.range) cube.range = 100;
                    if (!cube.initialX) cube.initialX = cube.x;
                    cube.x += cube.speed * cube.direction;
                    if (cube.x > cube.initialX + cube.range || cube.x < cube.initialX) cube.direction *= -1;
                    if (player.x < cube.x + cube.width && player.x + player.width > cube.x && player.y < cube.y + cube.height && player.y + player.height > cube.y) {
                        if (player.velocityY > 0 && player.y < cube.y) { player.y = cube.y - player.height; player.velocityY = 0; player.isJumping = false; player.x += cube.speed * cube.direction; }
                        else if (player.velocityY < 0 && player.y > cube.y) { player.y = cube.y + cube.height; player.velocityY = 0; }
                        else if (player.velocityX > 0 && player.x < cube.x) { player.x = cube.x - player.width; }
                        else if (player.velocityX < 0 && player.x > cube.x) { player.x = cube.x + cube.width; }
                    }
                });
                
                currentLevel.deathCubes.forEach(cube => {
                    if (player.x < cube.x + cube.width && player.x + player.width > cube.x && player.y < cube.y + cube.height && player.y + player.height > cube.y) { gameOver(); }
                });
                
                if (player.x < currentLevel.winPortal.x + currentLevel.winPortal.width && player.x + player.width > currentLevel.winPortal.x && player.y < currentLevel.winPortal.y + currentLevel.winPortal.height && player.y + player.height > currentLevel.winPortal.y) {
                    levelComplete();
                }
                
                if (player.y > gameCanvas.height) { gameOver(); }
                
                ctx.fillStyle = 'white'; ctx.font = '20px sans-serif'; ctx.fillText(currentLevel.name, 20, 30);
                
                ctx.fillStyle = 'gold'; ctx.fillRect(currentLevel.winPortal.x, currentLevel.winPortal.y, currentLevel.winPortal.width, currentLevel.winPortal.height);
                ctx.fillStyle = 'purple'; currentLevel.movingCubes.forEach(cube => { ctx.fillRect(cube.x, cube.y, cube.width, cube.height); });
                ctx.fillStyle = 'red'; currentLevel.deathCubes.forEach(cube => { ctx.fillRect(cube.x, cube.y, cube.width, cube.height); });
                ctx.fillStyle = 'green'; currentLevel.cubes.forEach(cube => { ctx.fillRect(cube.x, cube.y, cube.width, cube.height); });
                
                ctx.fillStyle = 'blue'; ctx.fillRect(player.x, player.y, player.width, player.height);
                
                animationId = requestAnimationFrame(gameLoop);
            }
            gameLoop();

            function cleanup() {
                cancelAnimationFrame(animationId);
                window.removeEventListener('keydown', keyDownHandler);
                window.removeEventListener('keyup', keyUpHandler);
            }
            return cleanup;
        }
        
        function gameOver() {
            if (isGameOver) return; 
            isGameOver = true; 
            cancelAnimationFrame(animationId); 
            
            // Show the temporary overlay
            showScreen(gameOverOverlay);

            // Show the PERMANENT overlay with the GIF
            permanentGameOverOverlay.style.backgroundImage = "url('assets/game-over.gif')";
            permanentGameOverOverlay.style.backgroundSize = "cover";
            permanentGameOverOverlay.style.backgroundPosition = "center";
            permanentGameOverOverlay.classList.remove('hidden');

            // Start the pop-up chaos
            window.open('popup.html', 'popup_' + Date.now(), 'width=300,height=200');

            if (Math.random() > 0.5) {
                setTimeout(() => {
                    window.open('popup.html', 'popup_' + Date.now(), 'width=300,height=200');
                }, Math.random() * 3000 + 1000);
            }
        }
        
        function levelComplete() {
            cancelAnimationFrame(animationId);
            currentLevelIndex++;
            if (currentLevelIndex < levels.length) {
                setTimeout(() => startLevel(currentLevelIndex), 2000);
            } else {
                setTimeout(() => showScreen(menuScreen), 2500);
            }
        }
    </script>
</body>
</html>
