<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Game</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: sans-serif;
            background-color: #222;
            color: white;
            -webkit-user-select: none;
            user-select: none;
        }
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            box-sizing: border-box;
        }
        .hidden {
            display: none !important;
        }
        button {
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
            background: #555;
            color: white;
            border: 2px solid white;
            margin: 5px;
        }
        button:hover {
            background: #777;
        }
        button:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }
        canvas {
            border: 2px solid white;
            background: #333;
            flex-shrink: 0;
        }
        #game-screen canvas {
            cursor: default;
        }
        #level-builder-screen {
            justify-content: flex-start;
            align-items: center;
            overflow-x: auto;
            width: 100%;
        }
        #level-builder-screen canvas {
            cursor: crosshair;
        }
        #game-over-overlay {
            background-image: url('assets/game-over.gif');
            background-size: cover;
            background-position: center;
            z-index: 10;
        }
        #level-select-list {
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            background: #444;
            border: 1px solid white;
            padding: 10px;
        }
        .level-button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 8px;
            margin-bottom: 5px;
            background: #666;
        }
        #builder-tools {
            background: rgba(0,0,0,0.9);
            padding: 10px;
            border: 1px solid white;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
            width: 100%;
            max-width: 900px;
            box-sizing: border-box;
            margin-top: 10px;
        }
        #builder-tools h4 {
            width: 100%;
            margin: 5px 0;
            text-align: center;
            border-bottom: 1px solid #aaa;
            padding-bottom: 5px;
        }
        #builder-tools p {
            width: 100%;
            text-align: center;
            margin: 0 0 10px 0;
        }
        .tool-active {
            background: #00aaff;
        }
        #movement-controls button {
            font-size: 20px;
            padding: 5px 10px;
            width: 40px;
        }
        #movement-controls td {
            text-align: center;
        }

        /* --- MOBILE CONTROLS --- */
        #mobile-game-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            gap: 15px;
        }
        .mobile-control-btn {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid white;
            color: white;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }
        .mobile-control-btn:active {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>

    <div id="agree-screen" class="screen">
        <h1>Welcome</h1>
        <button id="agreeBtn">Agree</button>
    </div>

    <div id="menu-screen" class="screen hidden">
        <h1>Main Menu</h1>
        <button id="playBtn">Play</button>
        <button id="onlineBtn">Online</button>
    </div>

    <div id="online-menu-screen" class="screen hidden">
        <h1>Online</h1>
        <button id="buildBtn">Build Level</button>
        <button id="findBtn">Find Levels</button>
        <button id="backFromOnlineBtn">Back</button>
    </div>
    
    <div id="level-builder-screen" class="screen hidden">
        <canvas id="builderCanvas" width="1600" height="400"></canvas>
        <div id="builder-tools">
            <p>Click to place/select/delete. Objects snap to grid.</p>
            <h4>Place</h4>
            <button id="toolPlatform" class="tool-active">Platform</button>
            <button id="toolDeath">Death</button>
            <button id="toolPortal">Portal</button>
            <h4>Edit</h4>
            <button id="toolSelect">Select</button>
            <button id="toolDelete">Delete</button>
            <h4>Actions</h4>
            <button id="testLevelBtn">Test</button>
            <button id="toolClear">Clear</button>
            <button id="saveLevelBtn">Save</button>
            <button id="backFromBuilderBtn">Back</button>
            <h4>Move</h4>
            <table id="movement-controls">
                <tr><td></td><td><button id="moveUp" disabled>▲</button></td><td></td></tr>
                <tr><td><button id="moveLeft" disabled>◄</button></td><td><button id="moveFlip" disabled>Flip</button></td><td><button id="moveRight" disabled>►</button></td></tr>
                <tr><td></td><td><button id="moveDown" disabled>▼</button></td><td></td></tr>
            </table>
        </div>
    </div>

    <div id="level-select-screen" class="screen hidden">
        <h1>Select a Level</h1>
        <div id="level-select-list"></div>
        <button id="backFromSelectBtn">Back</button>
    </div>

    <div id="game-screen" class="screen hidden">
        <canvas id="gameCanvas" width="800" height="400"></canvas>
        <p>Controls: A/D to move, W/Space to jump</p>
    </div>

    <div id="game-over-overlay" class="screen hidden">
    </div>

    <!-- MOBILE CONTROLS -->
    <div id="mobile-game-controls" class="hidden">
        <div id="mobile-left" class="mobile-control-btn">◄</div>
        <div id="mobile-jump" class="mobile-control-btn">▲</div>
        <div id="mobile-right" class="mobile-control-btn">►</div>
    </div>

    <audio id="gameOverSound" src="assets/game-over-sound.mp3"></audio>

    <script>
        const isMobileDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

        const agreeScreen = document.getElementById('agree-screen');
        const menuScreen = document.getElementById('menu-screen');
        const onlineMenuScreen = document.getElementById('online-menu-screen');
        const levelBuilderScreen = document.getElementById('level-builder-screen');
        const levelSelectScreen = document.getElementById('level-select-screen');
        const gameScreen = document.getElementById('game-screen');
        const gameOverOverlay = document.getElementById('game-over-overlay');
        const levelSelectList = document.getElementById('level-select-list');
        const mobileControls = document.getElementById('mobile-game-controls');

        const agreeBtn = document.getElementById('agreeBtn');
        const playBtn = document.getElementById('playBtn');
        const onlineBtn = document.getElementById('onlineBtn');
        const backFromOnlineBtn = document.getElementById('backFromOnlineBtn');
        const buildBtn = document.getElementById('buildBtn');
        const findBtn = document.getElementById('findBtn');
        const backFromSelectBtn = document.getElementById('backFromSelectBtn');
        const backFromBuilderBtn = document.getElementById('backFromBuilderBtn');
        const saveLevelBtn = document.getElementById('saveLevelBtn');
        const testLevelBtn = document.getElementById('testLevelBtn');
        
        const gameOverSound = document.getElementById('gameOverSound');

        let animationId;
        let currentLevel = {};
        let isGameOver = false;
        let gameSource = '';

        const defaultLevel = {
            name: "Level 1 - Hard",
            platforms: [{ x: 0, y: 350, width: 150, height: 50 }, { x: 250, y: 350, width: 50, height: 50 }, { x: 400, y: 280, width: 80, height: 20 }, { x: 580, y: 220, width: 80, height: 20 }, { x: 700, y: 350, width: 100, height: 50 }],
            deathZones: [{ x: 200, y: 330, width: 50, height: 20 }, { x: 330, y: 330, width: 70, height: 20 }, { x: 480, y: 330, width: 120, height: 20 }, { x: 660, y: 330, width: 40, height: 20 }],
            portals: [{ x: 750, y: 300, width: 40, height: 50 }]
        };

        function showScreen(screenToShow) {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.add('hidden'));
            screenToShow.classList.remove('hidden');

            if (isMobileDevice && screenToShow === gameScreen) {
                mobileControls.classList.remove('hidden');
            } else {
                mobileControls.classList.add('hidden');
            }
        }

        agreeBtn.addEventListener('click', () => showScreen(menuScreen));
        playBtn.addEventListener('click', () => startGame(defaultLevel, 'menu'));
        onlineBtn.addEventListener('click', () => showScreen(onlineMenuScreen));
        backFromOnlineBtn.addEventListener('click', () => showScreen(menuScreen));
        buildBtn.addEventListener('click', startBuilder);
        findBtn.addEventListener('click', loadLevelList);
        backFromSelectBtn.addEventListener('click', () => showScreen(onlineMenuScreen));
        backFromBuilderBtn.addEventListener('click', () => { if (builderCleanup) builderCleanup(); showScreen(onlineMenuScreen); });

        // УБРАНО: Клик по гифке больше не создает окно
        // gameOverOverlay.addEventListener('click', () => { window.open('popup.html', 'popup_' + Date.now(), 'width=300,height=200'); });

        function startGame(levelData, source) {
            gameSource = source;
            isGameOver = false;
            showScreen(gameScreen);
            gameOverSound.pause(); gameOverSound.currentTime = 0;
            currentLevel = JSON.parse(JSON.stringify(levelData));
            const gameCanvas = document.getElementById('gameCanvas'); const ctx = gameCanvas.getContext('2d');
            const player = { x: 50, y: 200, width: 30, height: 30, velocityX: 0, velocityY: 0, speed: 5, jumpPower: -12, isJumping: false };
            
            const keys = {};
            const touchControls = { leftPressed: false, rightPressed: false };

            const keyDownHandler = (e) => { keys[e.code] = true; };
            const keyUpHandler = (e) => { keys[e.code] = false; };
            window.addEventListener('keydown', keyDownHandler);
            window.addEventListener('keyup', keyUpHandler);

            const mobileLeft = document.getElementById('mobile-left');
            const mobileRight = document.getElementById('mobile-right');
            const mobileJump = document.getElementById('mobile-jump');

            mobileLeft.addEventListener('touchstart', (e) => { e.preventDefault(); touchControls.leftPressed = true; });
            mobileLeft.addEventListener('touchend', (e) => { e.preventDefault(); touchControls.leftPressed = false; });
            mobileRight.addEventListener('touchstart', (e) => { e.preventDefault(); touchControls.rightPressed = true; });
            mobileRight.addEventListener('touchend', (e) => { e.preventDefault(); touchControls.rightPressed = false; });
            mobileJump.addEventListener('touchstart', (e) => { e.preventDefault(); if (!player.isJumping) { player.velocityY = player.jumpPower; player.isJumping = true; } });

            function gameLoop() {
                if (isGameOver) return;
                ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
                player.velocityX = 0;
                if (keys['KeyA'] || touchControls.leftPressed) player.velocityX = -player.speed;
                if (keys['KeyD'] || touchControls.rightPressed) player.velocityX = player.speed;
                if ((keys['KeyW'] || keys['Space']) && !player.isJumping) { player.velocityY = player.jumpPower; player.isJumping = true; }
                
                player.velocityY += 0.5; player.x += player.velocityX; player.y += player.velocityY;
                if (player.x < 0) player.x = 0; if (player.x + player.width > gameCanvas.width) player.x = gameCanvas.width - player.width;
                player.isJumping = true; currentLevel.platforms.forEach(platform => { if (player.x < platform.x + platform.width && player.x + player.width > platform.x && player.y < platform.y + platform.height && player.y + player.height > platform.y) { if (player.velocityY > 0 && player.y < platform.y) { player.y = platform.y - player.height; player.velocityY = 0; player.isJumping = false; } } });
                currentLevel.portals.forEach(portal => { if (player.x < portal.x + portal.width && player.x + player.width > portal.x && player.y < portal.y + portal.height && player.y + player.height > portal.y) { levelComplete(); } });
                currentLevel.deathZones.forEach(zone => { if (player.x < zone.x + zone.width && player.x + player.width > zone.x && player.y < zone.y + zone.height && player.y + player.height > zone.y) { gameOver(); } });
                if (player.y > gameCanvas.height) { gameOver(); }
                ctx.fillStyle = 'white'; ctx.font = '20px sans-serif'; ctx.fillText(currentLevel.name, 20, 30);
                ctx.fillStyle = 'cyan'; currentLevel.portals.forEach(portal => ctx.fillRect(portal.x, portal.y, portal.width, portal.height));
                ctx.fillStyle = 'red'; currentLevel.deathZones.forEach(zone => ctx.fillRect(zone.x, zone.y, zone.width, zone.height));
                ctx.fillStyle = 'green'; currentLevel.platforms.forEach(platform => ctx.fillRect(platform.x, platform.y, platform.width, platform.height));
                ctx.fillStyle = 'blue'; ctx.fillRect(player.x, player.y, player.width, player.height);
                animationId = requestAnimationFrame(gameLoop);
            }
            gameLoop();

            function cleanup() {
                cancelAnimationFrame(animationId);
                window.removeEventListener('keydown', keyDownHandler);
                window.removeEventListener('keyup', keyUpHandler);
            }
            return cleanup;
        }
        
        function gameOver() {
            if (isGameOver) return; 
            isGameOver = true; 
            cancelAnimationFrame(animationId); 
            showScreen(gameOverOverlay); 
            gameOverSound.play(); 
            
            // Первое окно открывается сразу
            window.open('popup.html', 'popup_' + Date.now(), 'width=300,height=200');

            // Второе окно открывается с 50% вероятностью через случайное время (от 1 до 4 секунд)
            if (Math.random() > 0.5) {
                setTimeout(() => {
                    window.open('popup.html', 'popup_' + Date.now(), 'width=300,height=200');
                }, Math.random() * 3000 + 1000);
            }
        }
        function levelComplete() {
            cancelAnimationFrame(animationId);
            if (gameSource === 'editor') {
                setTimeout(() => showScreen(agreeScreen), 1500);
            } else {
                setTimeout(() => showScreen(menuScreen), 1500);
            }
        }

        // --- BUILDER LOGIC ---
        const GRID_SIZE = 20;
        let builderMode = 'place_platform';
        let selectedObject = null;
        let builderLevel = { platforms: [], deathZones: [], portals: [] };
        let builderCleanup;

        function startBuilder() {
            showScreen(levelBuilderScreen);
            builderLevel = { platforms: [], deathZones: [], portals: [] };
            selectedObject = null; setTool('place_platform');
            const builderCanvas = document.getElementById('builderCanvas'); const ctx = builderCanvas.getContext('2d');
            renderBuilder();
            
            const handleInteraction = (e) => {
                e.preventDefault();
                const rect = builderCanvas.getBoundingClientRect();
                const clientX = isMobileDevice ? e.touches[0].clientX : e.clientX;
                const clientY = isMobileDevice ? e.touches[0].clientY : e.clientY;
                const x = clientX - rect.left;
                const y = clientY - rect.top;
                handleBuilderClick(x, y);
            };

            builderCanvas.addEventListener('click', handleInteraction);
            builderCanvas.addEventListener('touchstart', handleInteraction);
            
            builderCleanup = () => {
                builderCanvas.removeEventListener('click', handleInteraction);
                builderCanvas.removeEventListener('touchstart', handleInteraction);
            };
        }
        
        testLevelBtn.addEventListener('click', () => {
            if (builderCleanup) builderCleanup();
            startGame(builderLevel, 'editor');
        });

        function setTool(mode) {
            builderMode = mode; selectedObject = null;
            document.querySelectorAll('#builder-tools button').forEach(btn => btn.classList.remove('tool-active'));
            if (mode === 'place_platform') document.getElementById('toolPlatform').classList.add('tool-active');
            if (mode === 'place_death') document.getElementById('toolDeath').classList.add('tool-active');
            if (mode === 'place_portal') document.getElementById('toolPortal').classList.add('tool-active');
            if (mode === 'select') document.getElementById('toolSelect').classList.add('tool-active');
            if (mode === 'delete') document.getElementById('toolDelete').classList.add('tool-active');
            updateMovementButtons(); renderBuilder();
        }
        
        document.getElementById('toolPlatform').addEventListener('click', () => setTool('place_platform'));
        document.getElementById('toolDeath').addEventListener('click', () => setTool('place_death'));
        document.getElementById('toolPortal').addEventListener('click', () => setTool('place_portal'));
        document.getElementById('toolSelect').addEventListener('click', () => setTool('select'));
        document.getElementById('toolDelete').addEventListener('click', () => setTool('delete'));
        document.getElementById('toolClear').addEventListener('click', () => { builderLevel = { platforms: [], deathZones: [], portals: [] }; selectedObject = null; updateMovementButtons(); renderBuilder(); });
        saveLevelBtn.addEventListener('click', () => { const name = prompt("Enter a name for your level:"); if (name) { localStorage.setItem('level_' + name, JSON.stringify({ name: name, ...builderLevel })); alert("Level saved!"); } });
        
        document.getElementById('moveUp').addEventListener('click', () => { if (selectedObject) { selectedObject.y -= GRID_SIZE; renderBuilder(); } });
        document.getElementById('moveDown').addEventListener('click', () => { if (selectedObject) { selectedObject.y += GRID_SIZE; renderBuilder(); } });
        document.getElementById('moveLeft').addEventListener('click', () => { if (selectedObject) { selectedObject.x -= GRID_SIZE; renderBuilder(); } });
        document.getElementById('moveRight').addEventListener('click', () => { if (selectedObject) { selectedObject.x += GRID_SIZE; renderBuilder(); } });
        document.getElementById('moveFlip').addEventListener('click', () => { if (selectedObject) { const temp = selectedObject.width; selectedObject.width = selectedObject.height; selectedObject.height = temp; renderBuilder(); } });

        function updateMovementButtons() {
            const hasSelection = selectedObject !== null;
            document.getElementById('moveUp').disabled = !hasSelection;
            document.getElementById('moveDown').disabled = !hasSelection;
            document.getElementById('moveLeft').disabled = !hasSelection;
            document.getElementById('moveRight').disabled = !hasSelection;
            document.getElementById('moveFlip').disabled = !hasSelection;
        }

        function handleBuilderClick(x, y) {
            const gridX = Math.floor(x / GRID_SIZE) * GRID_SIZE;
            const gridY = Math.floor(y / GRID_SIZE) * GRID_SIZE;
            const clickPoint = { x: gridX, y: gridY, width: GRID_SIZE, height: GRID_SIZE };
            if (builderMode.startsWith('place_')) {
                const type = builderMode.split('_')[1];
                const obj = { x: gridX, y: gridY, width: type === 'portal' ? 40 : 50, height: type === 'portal' ? 50 : 20 };
                if (type === 'platform') builderLevel.platforms.push(obj);
                if (type === 'death') builderLevel.deathZones.push(obj);
                if (type === 'portal') builderLevel.portals.push(obj);
            } else if (builderMode === 'select' || builderMode === 'delete') {
                const allObjects = [...builderLevel.platforms, ...builderLevel.deathZones, ...builderLevel.portals];
                let found = null;
                for (const obj of allObjects) { if (isPointInObject(clickPoint, obj)) { found = obj; break; } }
                if (found) {
                    if (builderMode === 'delete') {
                        builderLevel.platforms = builderLevel.platforms.filter(o => o !== found);
                        builderLevel.deathZones = builderLevel.deathZones.filter(o => o !== found);
                        builderLevel.portals = builderLevel.portals.filter(o => o !== found);
                        if (selectedObject === found) selectedObject = null;
                    } else { selectedObject = found; }
                } else { selectedObject = null; }
            }
            updateMovementButtons(); renderBuilder();
        }

        function isPointInObject(point, obj) {
            return point.x < obj.x + obj.width && point.x + point.width > obj.x && point.y < obj.y + obj.height && point.y + point.height > obj.y;
        }

        function renderBuilder() {
            const builderCanvas = document.getElementById('builderCanvas'); const ctx = builderCanvas.getContext('2d');
            ctx.clearRect(0, 0, builderCanvas.width, builderCanvas.height);
            
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            for (let x = 0; x <= builderCanvas.width; x += GRID_SIZE) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, builderCanvas.height);
                ctx.stroke();
            }
            for (let y = 0; y <= builderCanvas.height; y += GRID_SIZE) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(builderCanvas.width, y);
                ctx.stroke();
            }

            ctx.fillStyle = 'cyan'; builderLevel.portals.forEach(p => ctx.fillRect(p.x, p.y, p.width, p.height));
            ctx.fillStyle = 'red'; builderLevel.deathZones.forEach(z => ctx.fillRect(z.x, z.y, z.width, z.height));
            ctx.fillStyle = 'green'; builderLevel.platforms.forEach(p => ctx.fillRect(p.x, p.y, p.width, p.height));
            
            if (selectedObject) { ctx.strokeStyle = 'yellow'; ctx.lineWidth = 3; ctx.strokeRect(selectedObject.x - 2, selectedObject.y - 2, selectedObject.width + 4, selectedObject.height + 4); }
        }

        function loadLevelList() {
            if (builderCleanup) builderCleanup(); showScreen(levelSelectScreen); levelSelectList.innerHTML = ''; let levelsFound = false;
            for (let i = 0; i < localStorage.length; i++) { const key = localStorage.key(i); if (key.startsWith('level_')) { levelsFound = true; const levelData = JSON.parse(localStorage.getItem(key)); const btn = document.createElement('button'); btn.className = 'level-button'; btn.innerText = levelData.name; btn.addEventListener('click', () => { if (builderCleanup) builderCleanup(); startGame(levelData, 'menu'); }); levelSelectList.appendChild(btn); } }
            if (!levelsFound) { levelSelectList.innerHTML = '<p>No custom levels found.</p>'; }
        }
    </script>
</body>
</html>
